import {
  ascending,
  descending,
  linkHorizontal,
  max,
  rollups,
  scaleLinear,
  scaleOrdinal,
  scalePoint,
  scaleSqrt,
  scaleTime,
  sum,
} from "d3";
import { nanoid } from "nanoid";
import type { GetStaticProps, NextPage } from "next";
import Head from "next/head";
import { Vector2 } from "three";
import EventPoint from "../../components/charts/timeline/EventPoint";
import Timeline from "../../components/charts/timeline/Timeline";
import TimelineGrid from "../../components/charts/timeline/TimelineGrid";
import Footer from "../../components/Footer";
import Heading, { Headings } from "../../components/Heading";
import PointLabel from "../../components/map/PointLabel";
import ProportionalSymbolLegend from "../../components/map/ProportionalSymbolLegend";
import Cross from "../../components/shapes/Cross";
import getCourseGenealogy from "../../lib/data/getCourseGenealogy";
import { fDateYear } from "../../lib/utilities/formaters";
import styles from "../../styles/home.module.css";
import { CourseGenealogy } from "../../types/CourseGenealogy";
import { LabelPlacement } from "../../types/LabelPlacement";

type Props = {
  courseGenealogy: CourseGenealogy;
};

const CourseGenealogy: NextPage<Props> = ({ courseGenealogy }) => {
  const linkGenerator = linkHorizontal();

  courseGenealogy.nodes.forEach((node) => {
    node.dateStart = new Date(node.dateStart);
    node.size = parseInt(node.size);
  });

  courseGenealogy.links.forEach((link) => {
    link.start = new Date(link.start.toString());
    link.end = new Date(link.end.toString());
  });

  const sumsPerYear = rollups(
    courseGenealogy.nodes,
    (v) => sum(v, (d) => d.size),
    (d) => d.dateStart
  );

  const genealogyHeight = 800;
  const barChartHeight = 100;
  const width = 1280;
  const height = genealogyHeight + barChartHeight;
  const margin = 40;
  const xScale = scaleTime()
    .domain([new Date("1949"), new Date("2022")])
    .range([margin, width - margin])
    .nice();
  const xScaleUnit = xScale(new Date("1")) - xScale(new Date("0"));
  const yScale = scalePoint()
    .range([margin, genealogyHeight])
    .domain(
      courseGenealogy.links
        .sort((a, b) => descending(new Date(a.start), new Date(b.start)))
        .sort((a, b) =>
          ascending(parseInt(a.stem.toString()), parseInt(b.stem.toString()))
        )
        .flatMap((d) => [d.source, d.target])
    );
  const heightScale = scaleLinear()
    .domain([0, max(courseGenealogy.nodes, (n) => n.size) ?? 0])
    .range([0, 25]);
  const yScaleSum = scaleLinear()
    .domain([0, max(sumsPerYear, (d) => d[1]) ?? 1])
    .range([barChartHeight - margin, 0]);

  const stems = courseGenealogy.links.reduce((stems, s) => {
    if (!stems.includes(s.stem)) stems.push(s.stem);
    return stems;
  }, [] as string[]);

  const colorScale = scaleOrdinal<string, string>()
    .domain(stems)
    .range([
      "orange",
      "red",
      "darkred",
      "purple",
      "cornflowerblue",
      "darkslateblue",
    ]);

  return (
    <>
      <Head>
        <title>ITC's courses</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <Heading Tag={Headings.H1}>Course Genealogy</Heading>
        <Heading Tag={Headings.H2}>
          Graduates of M.Sc. courses over time
        </Heading>
        <svg width={width} height={height}>
          <Timeline>
            <TimelineGrid scale={xScale} height={height} margin={margin} />
            <g id={"nodes"} opacity={0.8}>
              {courseGenealogy.nodes.map((node) => {
                const pos = {
                  x: xScale(node.dateStart),
                  y: yScale(node.yOffset),
                } as Vector2;
                const height = heightScale(node.size ?? 1) * 2;
                const width = xScaleUnit;
                return node.data?.value === "-" ? (
                  <Cross
                    position={pos}
                    length={2}
                    halos={[{ size: 4, color: "white" }]}
                  />
                ) : (
                  <rect
                    key={nanoid()}
                    x={pos.x - width / 2}
                    y={pos.y - height / 2}
                    width={width}
                    height={height}
                    fill={colorScale(node.fill ?? "")}
                  />
                );
              })}
            </g>
            <g id={"links"}>
              {courseGenealogy.links.map((link) => {
                const sourcePos = new Vector2(
                  xScale(link.start),
                  yScale(link.source) ?? 1
                );
                const targetPos = new Vector2(
                  xScale(link.end),
                  yScale(link.target) ?? 1
                );
                const labelPos = sourcePos
                  .clone()
                  .add(targetPos.clone().sub(sourcePos).multiplyScalar(0.5))
                  .add(new Vector2(0, 2.5));
                return (
                  <g key={nanoid()}>
                    <path
                      key={nanoid()}
                      stroke={"black"}
                      d={
                        linkGenerator({
                          source: [sourcePos.x, sourcePos.y],
                          target: [targetPos.x, targetPos.y],
                        }) || ""
                      }
                      fill={"none"}
                    />
                    <g>
                      {[sourcePos, targetPos].map((p) => (
                        <EventPoint
                          key={nanoid()}
                          position={p}
                          fill={"white"}
                          stroke={"black"}
                          radius={1.5}
                        ></EventPoint>
                      ))}
                    </g>
                    {link.source === link.target && (
                      <PointLabel
                        position={labelPos}
                        placement={LabelPlacement.TOP}
                        style={{ fontSize: 7, fill: "bold" }}
                      >
                        <tspan fontWeight={"bold"}>{link.source}</tspan> (
                        {fDateYear(link.start)}â€“{fDateYear(link.end)})
                      </PointLabel>
                    )}
                  </g>
                );
              })}
            </g>
            <g id="sum-layer" transform={`translate(0, ${genealogyHeight})`}>
              {sumsPerYear.map(([key, value]) => {
                return (
                  <rect
                    key={nanoid()}
                    x={xScale(new Date(key))}
                    y={yScaleSum(value)}
                    width={xScaleUnit - 0.5}
                    height={barChartHeight - margin - yScaleSum(value)}
                  />
                );
              })}
            </g>
          </Timeline>
          <ProportionalSymbolLegend
            x={margin}
            y={height / 3}
            data={courseGenealogy.nodes.map((n) => n.size ?? 0)}
            scaleRadius={heightScale}
            title={"Graduates per course per year"}
            unitLabel={"graduates"}
          />
        </svg>
      </main>

      <Footer />
    </>
  );
};

export const getStaticProps: GetStaticProps<Props> = async () => {
  const courseGenealogy = await getCourseGenealogy();
  return {
    props: {
      courseGenealogy,
    },
  };
};

export default CourseGenealogy;
